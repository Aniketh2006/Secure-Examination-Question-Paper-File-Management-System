<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Question Paper Vault</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2.48.0/dist/umd/supabase.min.js"></script>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
</head>
<body class="min-h-screen bg-slate-950 text-slate-50 flex items-center justify-center">
  <div class="w-full max-w-6xl mx-auto px-4 py-8">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
      <div>
        <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full border border-sky-500/60 bg-sky-500/10 text-sky-200 text-xs mb-3">
          <i class="fa-solid fa-building-columns"></i>
          <span>MIT MANIPAL â€¢ EXAM ARCHIVE</span>
        </div>
        <h1 class="text-3xl font-semibold tracking-tight">
          Question Paper Vault
        </h1>
        <p class="text-slate-400 text-sm mt-1">
          Secure sem-wise collection of midsem & endsem papers, organized by branch and year.
        </p>
      </div>
      <button
        class="rounded-full bg-rose-500 hover:bg-rose-600 text-sm font-medium px-4 py-2 shadow-lg shadow-rose-500/30">
        Logout
      </button>
    </div>

    <!-- Toolbar -->
    <div class="flex items-center justify-between mb-4">
      <div id="breadcrumb" class="text-xs text-slate-400"></div>
      <div class="flex gap-3">
        <button id="backBtn"
          class="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-slate-800/80 border border-slate-700 text-xs hover:bg-slate-700">
          <i class="fa-solid fa-arrow-left-long"></i>
          <span>Back</span>
        </button>
        <button id="newFolderBtn"
          class="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-violet-500 hover:bg-violet-600 text-xs font-semibold shadow-md shadow-violet-500/40">
          <i class="fa-solid fa-folder-plus"></i>
          <span>New Folder</span>
        </button>
        <label
          class="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-xs font-semibold cursor-pointer shadow-md shadow-emerald-500/40">
          <i class="fa-solid fa-file-arrow-up"></i>
          <span>Upload PDF</span>
          <input id="fileInput" type="file" accept="application/pdf" class="hidden" />
        </label>
      </div>
    </div>

    <!-- Content -->
    <div
      class="rounded-3xl bg-gradient-to-br from-slate-900/90 via-slate-950 to-slate-950 border border-slate-800/90 shadow-xl shadow-sky-500/10 p-6">
      <div id="grid"
        class="grid grid-cols-1 md:grid-cols-3 gap-5 items-start">
        <!-- Folder cards (left) + PDF list (full width rows) injected here -->
      </div>
      <div id="emptyState" class="hidden text-center text-slate-500 text-sm py-16">
        No folders or files yet in this level.
      </div>
    </div>
  </div>

  <script>
    // --------- Supabase config ----------
    const SUPABASE_URL = "https://yzdbskvnfoogboeuxtyi.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl6ZGJza3ZuZm9vZ2JvZXV4dHlpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzMjEyMzEsImV4cCI6MjA4MTg5NzIzMX0.VkvjqtkRipYp_GLGv6hUYx9JYCCeq6w6j9GHru1fBFw";
    const BUCKET = "question-papers";                              

    const supabase = supabase_js.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // currentPath: [] means bucket ROOT
    let currentPath = [];

    // ---------- Helpers ----------
    function getCurrentPathString() {
      return currentPath.length === 0 ? "" : currentPath.join("/");
    }

    function updateBreadcrumb() {
      const el = document.getElementById("breadcrumb");
      const parts = [];

      if (currentPath.length === 0) {
        parts.push('<span class="text-slate-300">ROOT</span>');
      } else {
        parts.push(
          '<button class="text-slate-300 hover:text-sky-300" onclick="navigateToRoot()">ROOT</button>'
        );
        currentPath.forEach((segment, idx) => {
          const clickable = idx < currentPath.length - 1;
          if (clickable) {
            parts.push(
              `<span class="mx-1 text-slate-600">/</span><button class="hover:text-sky-300" onclick="navigateToIndex(${idx})">${segment}</button>`
            );
          } else {
            parts.push(
              `<span class="mx-1 text-slate-600">/</span><span class="text-sky-300">${segment}</span>`
            );
          }
        });
      }

      el.innerHTML = parts.join("");
    }

    function navigateToRoot() {
      currentPath = [];
      loadFiles();
    }

    function navigateToIndex(idx) {
      currentPath = currentPath.slice(0, idx + 1);
      loadFiles();
    }

    function downloadFromUrl(url, name) {
      const a = document.createElement("a");
      a.href = url;
      a.download = name;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    // ---------- Load files & folders ----------
    async function loadFiles() {
      updateBreadcrumb();

      const path = getCurrentPathString();

      const { data, error } = await supabase.storage
        .from(BUCKET)
        .list(path, {
          limit: 100,
          offset: 0,
          sortBy: { column: "name", order: "asc" }
        });

      if (error) {
        console.error("Error listing:", error);
        alert("Error listing files: " + error.message);
        return;
      }

      const grid = document.getElementById("grid");
      const emptyState = document.getElementById("emptyState");
      grid.innerHTML = "";

      if (!data || data.length === 0) {
        emptyState.classList.remove("hidden");
        return;
      } else {
        emptyState.classList.add("hidden");
      }

      const folders = data.filter((item) => item.name.endsWith("/") || item.metadata?.is_dir);
      const files = data.filter((item) => !folders.includes(item));

      const folderCards = [];
      const fileRows = [];

      // --- folder cards as boxes (grid) ---
      folders.forEach((folder) => {
        const name = folder.name.replace(/\/$/, "");
        folderCards.push(`
          <button
            class="w-full h-40 rounded-2xl bg-slate-900/80 border border-slate-700 hover:border-sky-500 hover:bg-slate-900 flex flex-col items-center justify-center gap-3 transition-colors"
            onclick="enterFolder('${name}')">
            <i class="fa-solid fa-folder text-4xl text-amber-400"></i>
            <span class="text-sm font-semibold tracking-wide text-slate-100">${name}</span>
          </button>
        `);
      });

      // --- pdf rows as full-width stacked list (readable names) ---
      for (const file of files) {
        const fullName = file.name;
        const fullPath = path ? `${path}/${fullName}` : fullName;

        const { data: urlData, error: urlError } = supabase.storage
          .from(BUCKET)
          .getPublicUrl(fullPath);

        if (urlError) continue;
        const url = urlData.publicUrl;

        fileRows.push(`
          <div class="col-span-full">
            <div
              class="flex items-center justify-between gap-3 px-4 py-3 rounded-xl bg-slate-900/70 border border-slate-700/70 hover:border-sky-500/70 hover:bg-slate-900 cursor-pointer"
              onclick="downloadFromUrl('${url}', '${fullName}')">
              <div class="flex items-center gap-3">
                <i class="fa-solid fa-file-pdf text-rose-400 text-xl"></i>
                <div class="text-sm font-medium text-slate-100 break-all">
                  ${fullName}
                </div>
              </div>
              <i class="fa-solid fa-download text-slate-300 text-xs"></i>
            </div>
          </div>
        `);
      }

      // put folders first, then pdf rows
      grid.innerHTML = `
        ${folderCards.join("")}
        ${fileRows.join("")}
      `;
    }

    window.enterFolder = function (name) {
      currentPath.push(name);
      loadFiles();
    };

    // ---------- New folder ----------
    async function createFolder() {
      const folderName = prompt("Enter folder name:");
      if (!folderName) return;

      const safeName = folderName.trim();
      if (!safeName) return;

      const path = getCurrentPathString();
      const folderPath = path ? `${path}/${safeName}/keep.txt` : `${safeName}/keep.txt`;

      const { error } = await supabase.storage
        .from(BUCKET)
        .upload(folderPath, new Blob(["keep"], { type: "text/plain" }), {
          upsert: false
        });

      if (error) {
        alert("Error creating folder: " + error.message);
      } else {
        loadFiles();
      }
    }

    // ---------- Upload PDF ----------
    async function uploadPdf(file) {
      if (!file) return;

      const path = getCurrentPathString();
      const finalPath = path ? `${path}/${file.name}` : file.name;

      const { error } = await supabase.storage
        .from(BUCKET)
        .upload(finalPath, file, {
          contentType: "application/pdf",
          upsert: false
        });

      if (error) {
        alert("Upload failed: " + error.message);
      } else {
        loadFiles();
      }
    }

    // ---------- Event listeners ----------
    document.getElementById("backBtn").addEventListener("click", () => {
      if (currentPath.length === 0) return;
      currentPath.pop();
      loadFiles();
    });

    document.getElementById("newFolderBtn").addEventListener("click", createFolder);

    document.getElementById("fileInput").addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) uploadPdf(file);
      e.target.value = "";
    });

    // ---------- Initial ----------
    loadFiles();
  </script>
</body>
</html>
