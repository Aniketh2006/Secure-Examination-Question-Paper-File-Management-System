<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MIT Manipal Question Paper Vault</title>

  <!-- UI libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Firebase + App code -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import {
      getStorage,
      ref,
      uploadBytes,
      getDownloadURL,
      listAll
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

    // ---------- 1) Firebase config ----------
    const firebaseConfig = {
      apiKey: "AIzaSyB1f9MxzzfxwOGF4DtsRurS3Ze10JRQLG4",
      authDomain: "mit-question-vault.firebaseapp.com",
      projectId: "mit-question-vault",
      storageBucket: "mit-question-vault.firebasestorage.app",
      messagingSenderId: "956482164050",
      appId: "1:956482164050:web:bdd17b212ea8d5ba10968b",
      measurementId: "G-J5CTJJ8DK9"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const storage = getStorage(app);

    // ---------- 2) State ----------
    let currentPath = [];   // inside SEM3
    let currentUser = null;

    // ---------- 3) DOM ready ----------
    window.addEventListener("DOMContentLoaded", () => {
      setupAuthListeners();
      setupAppListeners();
      updateBreadcrumb();

      document.getElementById("loginModal").classList.remove("hidden");
      document.getElementById("mainApp").classList.add("hidden");

      onAuthStateChanged(auth, (user) => {
        currentUser = user;
        document.getElementById("userEmail").textContent = user ? user.email : "";
      });
    });

    // ---------- 4) Auth ----------
    function setupAuthListeners() {
      document.getElementById("loginForm").addEventListener("submit", login);
      document.getElementById("goSignup").addEventListener("click", switchToSignup);
    }

    async function login(e) {
      e.preventDefault();
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;

      try {
        const cred = await signInWithEmailAndPassword(auth, email, password);
        currentUser = cred.user;
        showMainApp();
        currentPath = [];
        await loadFiles();
      } catch (err) {
        alert("Login failed: " + err.message);
      }
    }

    function switchToSignup() {
      const card = document.getElementById("authCard");
      card.innerHTML = `
        <h2 class="text-2xl font-semibold text-slate-50 mb-1 text-center">Student Sign Up</h2>
        <p class="text-slate-400 text-xs text-center mb-6">
          Create an account with your student email to upload papers.
        </p>
        <form id="signupForm" class="space-y-4">
          <div>
            <label class="block text-xs text-slate-400 mb-1">Email</label>
            <input type="email" id="signupEmail"
                   class="w-full px-3 py-2 rounded-xl bg-slate-900/60 border border-slate-700/70 text-slate-100 text-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500"
                   placeholder="student@manipal.edu" required>
          </div>
          <div>
            <label class="block text-xs text-slate-400 mb-1">Password</label>
            <input type="password" id="signupPassword"
                   class="w-full px-3 py-2 rounded-xl bg-slate-900/60 border border-slate-700/70 text-slate-100 text-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500"
                   placeholder="••••••••" required>
          </div>
          <button type="submit"
                  class="w-full bg-emerald-500 hover:bg-emerald-600 text-white py-2.5 rounded-xl text-sm font-semibold shadow-lg shadow-emerald-500/40">
            Sign Up
          </button>
        </form>
        <p class="text-center mt-4 text-xs text-slate-400">
          Already registered?
          <button id="goLogin" class="text-sky-300 font-semibold hover:text-sky-200 underline-offset-2 hover:underline">
            Back to login
          </button>
        </p>
      `;
      document.getElementById("signupForm").addEventListener("submit", signup);
      document.getElementById("goLogin").addEventListener("click", () => location.reload());
    }

    async function signup(e) {
      e.preventDefault();
      const email = document.getElementById("signupEmail").value;
      const password = document.getElementById("signupPassword").value;
      try {
        await createUserWithEmailAndPassword(auth, email, password);
        alert("Signup success. Now login with your credentials.");
        location.reload();
      } catch (err) {
        alert("Signup failed: " + err.message);
      }
    }

    function showMainApp() {
      document.getElementById("loginModal").classList.add("hidden");
      document.getElementById("mainApp").classList.remove("hidden");
      document.getElementById("userEmail").classList.remove("hidden");
      document.getElementById("logoutBtn").classList.remove("hidden");
    }

    // ---------- 5) App controls ----------
    function setupAppListeners() {
      document.getElementById("logoutBtn").onclick = async () => {
        await signOut(auth);
        location.reload();
      };

      document.getElementById("fileInput").onchange = handleUpload;

      document.getElementById("newFolderBtn").onclick =
        () => document.getElementById("folderForm").classList.toggle("hidden");

      document.getElementById("createFolderBtn").onclick = () => createFolder();

      document.getElementById("cancelFolderBtn").onclick =
        () => document.getElementById("folderForm").classList.add("hidden");

      document.getElementById("backBtn").onclick = () => {
        if (currentPath.length > 0) {
          currentPath.pop();
          loadFiles();
        }
      };
    }

    async function handleUpload(e) {
      const file = e.target.files[0];
      if (!file) return;
      if (!currentUser) { alert("Please login first."); return; }

      const baseSegments = ["SEM3", ...currentPath];
      const path = [...baseSegments, file.name].join("/");
      const fileRef = ref(storage, path);

      try {
        await uploadBytes(fileRef, file);
        await loadFiles();
        e.target.value = "";
        alert("File uploaded.");
      } catch (err) {
        alert("Upload failed: " + err.message);
      }
    }

    async function createFolder() {
      const sem = document.getElementById("semSelect").value;
      const branch = document.getElementById("branchSelect").value;
      const year = document.getElementById("yearSelect").value;
      const examType = document.getElementById("examTypeSelect").value;
      const subject = document.getElementById("subjectInput").value.trim();

      if (!sem || !branch || !year || !examType || !subject) {
        alert("Select semester, branch, year, exam type and subject.");
        return;
      }

      const folderPath = `SEM3/${sem}/${branch}/${year}/${examType}/${subject}/keep.txt`;
      const dummyRef = ref(storage, folderPath);
      const blob = new Blob(["folder"], { type: "text/plain" });

      try {
        await uploadBytes(dummyRef, blob);
        currentPath = [];
        await loadFiles();
        document.getElementById("folderForm").classList.add("hidden");
        document.querySelectorAll("#folderForm select, #folderForm input")
          .forEach(el => el.value = "");
        alert("Folder created.");
      } catch (err) {
        alert("Folder failed: " + err.message);
      }
    }

    // ---------- 6) List files/folders ----------
    async function loadFiles() {
      updateBreadcrumb();

      const base = currentPath.length === 0
        ? "SEM3"
        : ["SEM3", ...currentPath].join("/");

      const listRef = ref(storage, base);

      try {
        const res = await listAll(listRef);
        const container = document.getElementById("filesContainer");

        if (res.prefixes.length === 0 && res.items.length === 0) {
          container.innerHTML = `
            <div class="col-span-full flex flex-col items-center justify-center py-10 text-slate-400 text-sm">
              <i class="fa-regular fa-folder-open text-4xl mb-2"></i>
              <p>No items here yet. Create a folder or upload a PDF.</p>
            </div>`;
          return;
        }

        const folderCards = res.prefixes.map(p => {
          const name = p.name;
          return `
            <div class="grid-card bg-slate-900/70 border border-slate-700/70 rounded-2xl px-4 py-4 flex flex-col items-center text-center cursor-pointer transition-all duration-200 hover:border-sky-500/70 hover:bg-slate-900"
                 onclick="navigateFolder('${name}')">
              <i class="fa-solid fa-folder text-amber-400 text-3xl mb-3"></i>
              <div class="text-xs font-medium text-slate-100 truncate w-full">${name}</div>
            </div>`;
        });

        const fileCards = await Promise.all(res.items.map(async itemRef => {
          const fullName = itemRef.name.split("/").pop();
          const url = await getDownloadURL(itemRef);
          return `
            <div class="grid-card bg-slate-900/70 border border-slate-700/70 rounded-2xl px-4 py-4 flex flex-col items-center text-center cursor-pointer transition-all duration-200 hover:border-sky-500/70 hover:bg-slate-900"
                 onclick="downloadFromUrl('${url}','${fullName}')">
              <i class="fa-solid fa-file-pdf text-rose-400 text-3xl mb-3"></i>
              <div class="text-xs font-medium text-slate-100 truncate w-full">${fullName}</div>
            </div>`;
        }));

        container.innerHTML = folderCards.concat(fileCards).join("");
      } catch (err) {
        console.error(err);
        alert("Failed to load files: " + err.message);
      }
    }

    function updateBreadcrumb() {
      const bc = document.getElementById("breadcrumb");
      let html = '<i class="fa-solid fa-house text-sky-300 mr-1"></i>';
      if (currentPath.length === 0) {
        html += '<span class="text-slate-300 text-xs">SEM3</span>';
      } else {
        html += '<button class="text-slate-300 hover:text-sky-300 text-xs mr-1" onclick="currentPath=[]; loadFiles();">SEM3</button>';
      }
      currentPath.forEach((part, idx) => {
        html += `
          <span class="mx-1 text-slate-500">/</span>
          <button class="text-slate-200 hover:text-sky-300 text-xs"
                  onclick="currentPath = currentPath.slice(0,${idx+1}); loadFiles();">
            ${part}
          </button>`;
      });
      bc.innerHTML = html;
    }

    // ---------- 7) expose functions to window for inline onclick ----------
    window.navigateFolder = (name) => {
      if (!name) return;
      currentPath.push(name);
      loadFiles();
    };

    window.downloadFromUrl = (url, filename) => {
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      a.click();
    };

    window.loadFiles = () => loadFiles();
    window.createFolder = () => createFolder();
  </script>

  <style>
    * { font-family: 'Inter', sans-serif; }
    body {
      min-height: 100vh;
      background: radial-gradient(circle at top left, #4f46e5 0, #111827 40%, #020617 100%);
    }
    .glass-card {
      background: linear-gradient(135deg, rgba(15,23,42,0.85), rgba(30,64,175,0.7));
      box-shadow: 0 25px 60px rgba(15,23,42,0.8);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(148,163,184,0.35);
    }
    .floating { animation: float 8s ease-in-out infinite; }
    @keyframes float {
      0%,100% { transform: translateY(0px); }
      50% { transform: translateY(-12px); }
    }
    .badge {
      background: linear-gradient(135deg, rgba(59,130,246,0.18), rgba(56,189,248,0.15));
      border: 1px solid rgba(96,165,250,0.5);
    }
    .grid-card:hover {
      transform: translateY(-6px) scale(1.02);
      box-shadow: 0 25px 50px -12px rgba(15,23,42,0.9);
    }
  </style>
</head>
<body class="flex items-center justify-center px-4 py-10">

  <!-- Background orbs -->
  <div class="fixed inset-0 pointer-events-none overflow-hidden">
    <div class="absolute -top-24 -left-16 w-64 h-64 bg-indigo-500 rounded-full mix-blend-screen opacity-40 blur-3xl floating"></div>
    <div class="absolute -bottom-24 -right-10 w-80 h-80 bg-sky-500 rounded-full mix-blend-screen opacity-40 blur-3xl floating" style="animation-delay:-4s"></div>
  </div>

  <!-- Wrapper -->
  <div class="relative w-full max-w-6xl">

    <!-- Header -->
    <div class="mb-8 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div>
        <div class="inline-flex items-center badge px-3 py-1 rounded-full text-xs uppercase tracking-wide text-sky-100">
          <i class="fa-solid fa-building-columns mr-2"></i> MIT Manipal • Exam Archive
        </div>
        <h1 class="mt-3 text-3xl md:text-4xl font-bold text-slate-50">
          Question Paper Vault
        </h1>
        <p class="mt-1 text-slate-300 text-sm md:text-base">
          Secure sem‑wise collection of midsem & endsem papers, organized by branch and year.
        </p>
      </div>
      <div class="flex items-center gap-3 justify-between md:justify-end">
        <span id="userEmail" class="hidden md:inline-block text-xs bg-slate-900/60 border border-slate-700/70 px-3 py-1 rounded-full text-slate-200"></span>
        <button id="logoutBtn"
                class="hidden bg-rose-500 hover:bg-rose-600 text-white px-4 py-2 rounded-xl text-sm font-semibold shadow-lg shadow-rose-500/40">
          <i class="fa-solid fa-arrow-right-from-bracket mr-2"></i>Logout
        </button>
      </div>
    </div>

    <!-- Login / Signup modal card -->
    <div id="loginModal" class="glass-card rounded-3xl p-8 md:p-10 max-w-md mx-auto mb-8">
      <div id="authCard">
        <h2 class="text-2xl font-semibold text-slate-50 mb-1 text-center">Student Login</h2>
        <p class="text-slate-400 text-xs text-center mb-6">
          Use your college email to access the question paper repository.
        </p>

        <form id="loginForm" class="space-y-4">
          <div>
            <label class="block text-xs text-slate-400 mb-1">Email</label>
            <input type="email" id="email"
                   class="w-full px-3 py-2 rounded-xl bg-slate-900/60 border border-slate-700/70 text-slate-100 text-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none"
                   placeholder="student@manipal.edu" required>
          </div>
          <div>
            <label class="block text-xs text-slate-400 mb-1">Password</label>
            <input type="password" id="password"
                   class="w-full px-3 py-2 rounded-xl bg-slate-900/60 border border-slate-700/70 text-slate-100 text-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none"
                   placeholder="••••••••" required>
          </div>
          <button type="submit"
                  class="w-full bg-sky-500 hover:bg-sky-600 text-white py-2.5 rounded-xl text-sm font-semibold shadow-lg shadow-sky-500/40">
            Login
          </button>
        </form>

        <p class="text-center mt-4 text-xs text-slate-400">
          New here?
          <button id="goSignup" class="text-sky-300 font-semibold hover:text-sky-200 underline-offset-2 hover:underline">
            Create student account
          </button>
        </p>
      </div>
    </div>

    <!-- Main app (hidden until login) -->
    <div id="mainApp" class="hidden glass-card rounded-3xl p-6 md:p-8 text-slate-50">
      <!-- Top controls -->
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
        <div class="flex flex-wrap items-center gap-2">
          <div id="breadcrumb" class="flex flex-wrap items-center text-xs md:text-sm text-slate-300"></div>
        </div>
        <div class="flex flex-wrap gap-2">
          <button id="backBtn"
                  class="px-3 py-2 rounded-xl text-xs md:text-sm font-medium bg-slate-900/60 border border-slate-600 hover:bg-slate-800 flex items-center gap-2">
            <i class="fa-solid fa-arrow-left"></i><span>Back</span>
          </button>
          <button id="newFolderBtn"
                  class="px-3 py-2 rounded-xl text-xs md:text-sm font-medium bg-violet-500 hover:bg-violet-600 flex items-center gap-2 shadow-md shadow-violet-500/40">
            <i class="fa-solid fa-folder-plus"></i><span>New Folder</span>
          </button>
          <label
            class="px-3 py-2 rounded-xl text-xs md:text-sm font-medium bg-emerald-500 hover:bg-emerald-600 flex items-center gap-2 cursor-pointer shadow-md shadow-emerald-500/40">
            <i class="fa-solid fa-cloud-arrow-up"></i><span>Upload PDF</span>
            <input type="file" id="fileInput" accept=".pdf" class="hidden">
          </label>
        </div>
      </div>

      <!-- Folder creation form -->
      <div id="folderForm"
           class="hidden mb-6 rounded-2xl border border-slate-700 bg-slate-900/60 px-4 py-4 md:px-5 md:py-5">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-sm font-semibold text-slate-100 flex items-center gap-2">
            <i class="fa-solid fa-layer-group text-violet-400"></i>
            Create sem → branch → year → exam → subject folder
          </h3>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-3 text-xs">
          <select id="semSelect"
                  class="px-3 py-2 rounded-xl bg-slate-950/70 border border-slate-700 text-slate-100 focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
            <option value="">Semester</option>
            <option value="SEM1">SEM 1</option>
            <option value="SEM2">SEM 2</option>
            <option value="SEM3">SEM 3</option>
            <option value="SEM4">SEM 4</option>
            <option value="SEM5">SEM 5</option>
            <option value="SEM6">SEM 6</option>
            <option value="SEM7">SEM 7</option>
            <option value="SEM8">SEM 8</option>
          </select>

          <select id="branchSelect"
                  class="px-3 py-2 rounded-xl bg-slate-950/70 border border-slate-700 text-slate-100 focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
            <option value="">Branch (MIT Manipal)</option>
            <option value="CSE">CSE</option>
            <option value="CCE">CCE</option>
            <option value="ECE">ECE</option>
            <option value="EEE">EEE</option>
            <option value="ME">Mechanical</option>
            <option value="CIVIL">Civil</option>
            <option value="AERO">Aeronautical</option>
            <option value="MECHTRONICS">Mechatronics</option>
            <option value="BIO">Biotechnology/Biomedical</option>
            <option value="ICT">ICT</option>
          </select>

          <select id="yearSelect"
                  class="px-3 py-2 rounded-xl bg-slate-950/70 border border-slate-700 text-slate-100 focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
            <option value="">Year</option>
            <option value="2015">2015</option>
            <option value="2016">2016</option>
            <option value="2017">2017</option>
            <option value="2018">2018</option>
            <option value="2019">2019</option>
            <option value="2020">2020</option>
            <option value="2021">2021</option>
            <option value="2022">2022</option>
            <option value="2023">2023</option>
            <option value="2024">2024</option>
            <option value="2025">2025</option>
          </select>

          <select id="examTypeSelect"
                  class="px-3 py-2 rounded-xl bg-slate-950/70 border border-slate-700 text-slate-100 focus:ring-2 focus:ring-sky-500 focus-border-sky-500">
            <option value="">Exam Type</option>
            <option value="MIDSEM">Midsem</option>
            <option value="ENDSEM">Endsem</option>
          </select>

          <input id="subjectInput" placeholder="Subject (e.g., OS)"
                 class="px-3 py-2 rounded-xl bg-slate-950/70 border border-slate-700 text-slate-100 focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
        </div>

        <div class="flex flex-wrap gap-3 mt-4">
          <button id="createFolderBtn"
                  class="px-4 py-2 rounded-xl text-xs font-semibold bg-violet-500 hover:bg-violet-600 text-white shadow-md shadow-violet-500/40">
            Create Folder
          </button>
          <button id="cancelFolderBtn"
                  class="px-4 py-2 rounded-xl text-xs font-medium bg-transparent border border-slate-600 text-slate-300 hover:bg-slate-800/60">
            Cancel
          </button>
        </div>
      </div>

      <!-- File / folder grid -->
      <div id="filesContainer"
           class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-4">
      </div>
    </div>
  </div>
</body>
</html>
