<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MIT Manipal Question Paper Vault</title>

  <!-- UI libraries -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    * { font-family: 'Inter', sans-serif; }
    body {
      min-height: 100vh;
      background: radial-gradient(circle at top left, #4f46e5 0, #111827 40%, #020617 100%);
    }
    .glass-card {
      background: linear-gradient(135deg, rgba(15,23,42,0.85), rgba(30,64,175,0.7));
      box-shadow: 0 25px 60px rgba(15,23,42,0.8);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(148,163,184,0.35);
    }
    .floating { animation: float 8s ease-in-out infinite; }
    @keyframes float {
      0%,100% { transform: translateY(0px); }
      50% { transform: translateY(-12px); }
    }
    .badge {
      background: linear-gradient(135deg, rgba(59,130,246,0.18), rgba(56,189,248,0.15));
      border: 1px solid rgba(96,165,250,0.5);
    }
    .grid-card:hover {
      transform: translateY(-6px) scale(1.02);
      box-shadow: 0 25px 50px -12px rgba(15,23,42,0.9);
    }
  </style>
</head>
<body class="flex items-center justify-center px-4 py-10">

  <!-- Background orbs -->
  <div class="fixed inset-0 pointer-events-none overflow-hidden">
    <div class="absolute -top-24 -left-16 w-64 h-64 bg-indigo-500 rounded-full mix-blend-screen opacity-40 blur-3xl floating"></div>
    <div class="absolute -bottom-24 -right-10 w-80 h-80 bg-sky-500 rounded-full mix-blend-screen opacity-40 blur-3xl floating" style="animation-delay:-4s"></div>
  </div>

  <!-- Wrapper -->
  <div class="relative w-full max-w-6xl">

    <!-- Header -->
    <div class="mb-8 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div>
        <div class="inline-flex items-center badge px-3 py-1 rounded-full text-xs uppercase tracking-wide text-sky-100">
          <i class="fa-solid fa-building-columns mr-2"></i> MIT Manipal • Exam Archive
        </div>
        <h1 class="mt-3 text-3xl md:text-4xl font-bold text-slate-50">
          Question Paper Vault
        </h1>
        <p class="mt-1 text-slate-300 text-sm md:text-base">
          Secure sem‑wise collection of midsem & endsem papers, organized by branch and year.
        </p>
      </div>
      <div class="flex items-center gap-3 justify-between md:justify-end">
        <span id="userEmail" class="hidden md:inline-block text-xs bg-slate-900/60 border border-slate-700/70 px-3 py-1 rounded-full text-slate-200"></span>
        <button id="logoutBtn"
                class="hidden bg-rose-500 hover:bg-rose-600 text-white px-4 py-2 rounded-xl text-sm font-semibold shadow-lg shadow-rose-500/40">
          <i class="fa-solid fa-arrow-right-from-bracket mr-2"></i>Logout
        </button>
      </div>
    </div>

    <!-- Login / Signup modal card -->
    <div id="loginModal" class="glass-card rounded-3xl p-8 md:p-10 max-w-md mx-auto mb-8">
      <div id="authCard">
        <h2 class="text-2xl font-semibold text-slate-50 mb-1 text-center">Student Login</h2>
        <p class="text-slate-400 text-xs text-center mb-6">
          Use your college email to access the question paper repository.
        </p>

        <form id="loginForm" class="space-y-4">
          <div>
            <label class="block text-xs text-slate-400 mb-1">Email</label>
            <input type="email" id="email"
                   class="w-full px-3 py-2 rounded-xl bg-slate-900/60 border border-slate-700/70 text-slate-100 text-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none"
                   placeholder="student@manipal.edu" required>
          </div>
          <div>
            <label class="block text-xs text-slate-400 mb-1">Password</label>
            <input type="password" id="password"
                   class="w-full px-3 py-2 rounded-xl bg-slate-900/60 border border-slate-700/70 text-slate-100 text-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none"
                   placeholder="••••••••" required>
          </div>
          <button type="submit"
                  class="w-full bg-sky-500 hover:bg-sky-600 text-white py-2.5 rounded-xl text-sm font-semibold shadow-lg shadow-sky-500/40">
            Login
          </button>
        </form>

        <p class="text-center mt-4 text-xs text-slate-400">
          New here?
          <button id="goSignup" class="text-sky-300 font-semibold hover:text-sky-200 underline-offset-2 hover:underline">
            Create student account
          </button>
        </p>
      </div>
    </div>

    <!-- Main app (hidden until login) -->
    <div id="mainApp" class="hidden glass-card rounded-3xl p-6 md:p-8 text-slate-50">
      <!-- Top controls -->
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
        <div class="flex flex-wrap items-center gap-2">
          <div id="breadcrumb" class="flex flex-wrap items-center text-xs md:text-sm text-slate-300"></div>
        </div>
        <div class="flex flex-wrap gap-2">
          <button id="backBtn"
                  class="px-3 py-2 rounded-xl text-xs md:text-sm font-medium bg-slate-900/60 border border-slate-600 hover:bg-slate-800 flex items-center gap-2">
            <i class="fa-solid fa-arrow-left"></i><span>Back</span>
          </button>
          <button id="newFolderBtn"
                  class="px-3 py-2 rounded-xl text-xs md:text-sm font-medium bg-violet-500 hover:bg-violet-600 flex items-center gap-2 shadow-md shadow-violet-500/40">
            <i class="fa-solid fa-folder-plus"></i><span>New Folder</span>
          </button>
          <label
            class="px-3 py-2 rounded-xl text-xs md:text-sm font-medium bg-emerald-500 hover:bg-emerald-600 flex items-center gap-2 cursor-pointer shadow-md shadow-emerald-500/40">
            <i class="fa-solid fa-cloud-arrow-up"></i><span>Upload PDF</span>
            <input type="file" id="fileInput" accept=".pdf" class="hidden">
          </label>
        </div>
      </div>

      <!-- Folder creation form -->
      <div id="folderForm"
           class="hidden mb-6 rounded-2xl border border-slate-700 bg-slate-900/60 px-4 py-4 md:px-5 md:py-5">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-sm font-semibold text-slate-100 flex items-center gap-2">
            <i class="fa-solid fa-layer-group text-violet-400"></i>
            Create sem → branch → year → exam → subject folder
          </h3>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-3 text-xs">
          <select id="semSelect"
                  class="px-3 py-2 rounded-xl bg-slate-950/70 border border-slate-700 text-slate-100 focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
            <option value="">Semester</option>
            <option value="SEM1">SEM 1</option>
            <option value="SEM2">SEM 2</option>
            <option value="SEM3">SEM 3</option>
            <option value="SEM4">SEM 4</option>
            <option value="SEM5">SEM 5</option>
            <option value="SEM6">SEM 6</option>
            <option value="SEM7">SEM 7</option>
            <option value="SEM8">SEM 8</option>
          </select>

          <select id="branchSelect"
                  class="px-3 py-2 rounded-xl bg-slate-950/70 border border-slate-700 text-slate-100 focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
            <option value="">Branch (MIT Manipal)</option>
            <option value="CSE">CSE</option>
            <option value="CCE">CCE</option>
            <option value="ECE">ECE</option>
            <option value="EEE">EEE</option>
            <option value="ME">Mechanical</option>
            <option value="CIVIL">Civil</option>
            <option value="AERO">Aeronautical</option>
            <option value="MECHTRONICS">Mechatronics</option>
            <option value="BIO">Biotechnology/Biomedical</option>
            <option value="ICT">ICT</option>
          </select>

          <select id="yearSelect"
                  class="px-3 py-2 rounded-xl bg-slate-950/70 border border-slate-700 text-slate-100 focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
            <option value="">Year</option>
            <option value="2015">2015</option>
            <option value="2016">2016</option>
            <option value="2017">2017</option>
            <option value="2018">2018</option>
            <option value="2019">2019</option>
            <option value="2020">2020</option>
            <option value="2021">2021</option>
            <option value="2022">2022</option>
            <option value="2023">2023</option>
            <option value="2024">2024</option>
            <option value="2025">2025</option>
          </select>

          <select id="examTypeSelect"
                  class="px-3 py-2 rounded-xl bg-slate-950/70 border border-slate-700 text-slate-100 focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
            <option value="">Exam Type</option>
            <option value="MIDSEM">Midsem</option>
            <option value="ENDSEM">Endsem</option>
          </select>

          <input id="subjectInput" placeholder="Subject (e.g., OS)"
                 class="px-3 py-2 rounded-xl bg-slate-950/70 border border-slate-700 text-slate-100 focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
        </div>

        <div class="flex flex-wrap gap-3 mt-4">
          <button id="createFolderBtn"
                  class="px-4 py-2 rounded-xl text-xs font-semibold bg-violet-500 hover:bg-violet-600 text-white shadow-md shadow-violet-500/40">
            Create Folder
          </button>
          <button id="cancelFolderBtn"
                  class="px-4 py-2 rounded-xl text-xs font-medium bg-transparent border border-slate-600 text-slate-300 hover:bg-slate-800/60">
            Cancel
          </button>
        </div>
      </div>

      <!-- File / folder grid -->
      <div id="filesContainer"
           class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-4">
      </div>
    </div>
  </div>

  <!-- Main script -->
  <script>
    // 1) Supabase config (project yzdbskvnfoogboeuxtyi) [web:194]
    const SUPABASE_URL = 'https://yzdbskvnfoogboeuxtyi.supabase.co';
    const SUPABASE_ANON_KEY =
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl6ZGJza3ZuZm9vZ2JvZXV4dHlpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzMjEyMzEsImV4cCI6MjA4MTg5NzIzMX0.VkvjqtkRipYp_GLGv6hUYx9JYCCeq6w6j9GHru1fBFw';

    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        persistSession: false,   // force login every reload [web:291]
        autoRefreshToken: false
      }
    });

    let currentPath = [];
    let user = null;

    // Always show login on load (no auto session restore)
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('loginModal').classList.remove('hidden');
      document.getElementById('mainApp').classList.add('hidden');

      setupAuthListeners();
      setupAppListeners();
      updateBreadcrumb();
    });

    // ---------- Auth ----------
    function setupAuthListeners() {
      document.getElementById('loginForm').addEventListener('submit', login);
      document.getElementById('goSignup').addEventListener('click', switchToSignup);
    }

    async function login(e) {
      e.preventDefault();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      const { data, error } = await sb.auth.signInWithPassword({ email, password });
      if (error) {
        alert('Login failed: ' + error.message);
        return;
      }
      user = data.user;
      showMainApp();
      currentPath = [];
      await loadFiles();
    }

    function switchToSignup() {
      const card = document.getElementById('authCard');
      card.innerHTML = `
        <h2 class="text-2xl font-semibold text-slate-50 mb-1 text-center">Student Sign Up</h2>
        <p class="text-slate-400 text-xs text-center mb-6">
          Create an account with your student email to upload papers.
        </p>
        <form id="signupForm" class="space-y-4">
          <div>
            <label class="block text-xs text-slate-400 mb-1">Email</label>
            <input type="email" id="signupEmail"
                   class="w-full px-3 py-2 rounded-xl bg-slate-900/60 border border-slate-700/70 text-slate-100 text-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500"
                   placeholder="student@manipal.edu" required>
          </div>
          <div>
            <label class="block text-xs text-slate-400 mb-1">Password</label>
            <input type="password" id="signupPassword"
                   class="w-full px-3 py-2 rounded-xl bg-slate-900/60 border border-slate-700/70 text-slate-100 text-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500"
                   placeholder="••••••••" required>
          </div>
          <button type="submit"
                  class="w-full bg-emerald-500 hover:bg-emerald-600 text-white py-2.5 rounded-xl text-sm font-semibold shadow-lg shadow-emerald-500/40">
            Sign Up
          </button>
        </form>
        <p class="text-center mt-4 text-xs text-slate-400">
          Already registered?
          <button id="goLogin" class="text-sky-300 font-semibold hover:text-sky-200 underline-offset-2 hover:underline">
            Back to login
          </button>
        </p>
      `;
      document.getElementById('signupForm').addEventListener('submit', signup);
      document.getElementById('goLogin').addEventListener('click', () => location.reload());
    }

    async function signup(e) {
      e.preventDefault();
      const email = document.getElementById('signupEmail').value;
      const password = document.getElementById('signupPassword').value;
      const { error } = await sb.auth.signUp({ email, password });
      if (error) {
        alert('Signup failed: ' + error.message);
        return;
      }
      alert('Signup success. Verify email if required, then reload and login.');
    }

    function showMainApp() {
      document.getElementById('loginModal').classList.add('hidden');
      document.getElementById('mainApp').classList.remove('hidden');
      document.getElementById('userEmail').classList.remove('hidden');
      document.getElementById('logoutBtn').classList.remove('hidden');
      document.getElementById('userEmail').textContent = user?.email || '';
    }

    // ---------- App controls ----------
    function setupAppListeners() {
      document.getElementById('logoutBtn').onclick = async () => {
        await sb.auth.signOut();   // clear server-side session [web:280]
        location.reload();         // forces login again
      };
      document.getElementById('fileInput').onchange = handleUpload;
      document.getElementById('newFolderBtn').onclick =
        () => document.getElementById('folderForm').classList.toggle('hidden');
      document.getElementById('createFolderBtn').onclick = createFolder;
      document.getElementById('cancelFolderBtn').onclick =
        () => document.getElementById('folderForm').classList.add('hidden');
      document.getElementById('backBtn').onclick = () => {
        if (currentPath.length > 0) { currentPath.pop(); loadFiles(); }
      };
    }

    async function handleUpload(e) {
      const file = e.target.files[0];
      if (!file) return;
      if (!user) { alert('Please login first.'); return; }

      const path = [...currentPath, file.name].join('/');
      const { error } = await sb.storage.from('question-papers').upload(path, file);
      if (error) { alert('Upload failed: ' + error.message); }
      else { await loadFiles(); e.target.value = ''; alert('File uploaded.'); }
    }

    async function createFolder() {
      const sem = document.getElementById('semSelect').value;
      const branch = document.getElementById('branchSelect').value;
      const year = document.getElementById('yearSelect').value;
      const examType = document.getElementById('examTypeSelect').value;
      const subject = document.getElementById('subjectInput').value.trim();

      if (!sem || !branch || !year || !examType || !subject) {
        alert('Select semester, branch, year, exam type and subject.');
        return;
      }

      // SEM/BRANCH/YEAR/EXAMTYPE/SUBJECT/.keep
      const folderPath = `${sem}/${branch}/${year}/${examType}/${subject}/.keep`;

      const { error } = await sb.storage.from('question-papers')
        .upload(folderPath, new Blob(['folder'], { type: 'text/plain' }));
      if (error) {
        alert('Folder failed: ' + error.message);
      } else {
        currentPath = [];
        await loadFiles();
        document.getElementById('folderForm').classList.add('hidden');
        document.querySelectorAll('#folderForm select, #folderForm input')
          .forEach(el => el.value = '');
        alert('Folder created.');
      }
    }

    // ---------- Load files / folders ----------
    async function loadFiles() {
      updateBreadcrumb();

      const prefix = currentPath.join('/');

      const { data, error } = await sb.storage
        .from('question-papers')
        .list(prefix || '', {
          limit: 200,
          sortBy: { column: 'name', order: 'asc' }
        });

      // TEMP debug log – keep for now
      console.log('prefix =', `"${prefix}"`, 'data =', data, 'error =', error);

      if (error) {
        console.error('Error loading files:', error.message);
        return;
      }

      const container = document.getElementById('filesContainer');

      if (!data || data.length === 0) {
        container.innerHTML = `
          <div class="col-span-full flex flex-col items-center justify-center py-10 text-slate-400 text-sm">
            <i class="fa-regular fa-folder-open text-4xl mb-2"></i>
            <p>No items here yet. Create a folder or upload a PDF.</p>
          </div>
        `;
        return;
      }

      container.innerHTML = data.map(item => {
        // Supabase v2: folders have type === 'folder' [web:247]
        const isFolder = item.type === 'folder';

        const iconClass = isFolder ? 'fa-folder' : 'fa-file-pdf';
        const iconColor = isFolder ? 'text-amber-400' : 'text-rose-400';

        const displayName = item.name.replace(/\/$/, '');

        const onClick = isFolder
          ? `navigateFolder('${displayName}')`
          : `downloadFile('${item.name}')`;

        return `
          <div
            class="grid-card bg-slate-900/70 border border-slate-700/70 rounded-2xl px-4 py-4 flex flex-col items-center text-center cursor-pointer transition-all duration-200 hover:border-sky-500/70 hover:bg-slate-900"
            onclick="${onClick}"
          >
            <i class="fa-solid ${iconClass} ${iconColor} text-3xl mb-3"></i>
            <div class="text-xs font-medium text-slate-100 truncate w-full">
              ${displayName}
            </div>
          </div>
        `;
      }).join('');
    }

    function navigateFolder(name) {
      if (!name) return;
      currentPath.push(name);
      loadFiles();
    }

    function updateBreadcrumb() {
      const bc = document.getElementById('breadcrumb');
      let html = '<i class="fa-solid fa-house text-sky-300 mr-1"></i>';
      if (currentPath.length === 0) {
        html += '<span class="text-slate-300 text-xs">Root</span>';
      } else {
        html += '<button class="text-slate-300 hover:text-sky-300 text-xs mr-1" onclick="currentPath=[]; loadFiles();">Root</button>';
      }
      currentPath.forEach((part, idx) => {
        html += `
          <span class="mx-1 text-slate-500">/</span>
          <button class="text-slate-200 hover:text-sky-300 text-xs"
                  onclick="currentPath = currentPath.slice(0,${idx+1}); loadFiles();">
            ${part}
          </button>`;
      });
      bc.innerHTML = html;
    }

    async function downloadFile(filename) {
      const fullPath = [...currentPath, filename].join('/');
      const { data, error } = await sb.storage
        .from('question-papers')
        .createSignedUrl(fullPath, 60);
      if (error) {
        alert('Download failed: ' + error.message);
        return;
      }
      const a = document.createElement('a');
      a.href = data.signedURL;
      a.download = filename;
      a.click();
    }
  </script>
</body>
</html>
